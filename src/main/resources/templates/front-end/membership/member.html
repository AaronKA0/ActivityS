<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>會員</title>

    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500&display=swap">

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap"
            rel="stylesheet">
            
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
	integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />


<script
	src="https://cdn.tiny.cloud/1/tus9t8o6mklmhwd5c0iaejn9394stnli5i0j2ic9bb4xurm0/tinymce/6/tinymce.min.js"
	referrerpolicy="origin"></script>
<script
	src="https://cdn.jsdelivr.net/npm/@tinymce/tinymce-jquery@2/dist/tinymce-jquery.min.js"></script>


<script
	src="
https://cdn.jsdelivr.net/npm/paginationjs@2.6.0/dist/pagination.min.js
"></script>
<link
	href="
https://cdn.jsdelivr.net/npm/paginationjs@2.6.0/dist/pagination.min.css
"
	rel="stylesheet">

<script
	src="https://cdn.jsdelivr.net/gh/dealfonso/power-buttons/dist/powerbuttons.min.js"></script>


    <link rel="stylesheet" th:href="@{/front-end/zuo-huo/css/notify.css}">
    <link rel="stylesheet" th:href="@{/front-end/zuo-huo/css/ann.css}">
    
    <style>

.post, .post-title, .post-content {
	display: inline-block;
}

.post {
	border: solid black 1px;
	width: 800px;
	margin-top: 20px;
	margin-bottom: 20px;
}

.post-title {
	margin-top: 10px;
	margin-bottom: 20px;
}

.post-title h3 {
	font-weight: bold;
}

#add-post-title {
	margin-top: 20px;
	margin-bottom: 20px;
	width: 750px;
}

#post-sort:hover {
	cursor: pointer;
}

.status-li:hover {
	cursor: pointer;
}

#add-post:hover {
	cursor: pointer;
}

.paginationjs .paginationjs-pages {
	display: inline-block;
	float: none;
}

.paginationjs {
	text-align: center;
	display: block;
}

.visit-mem:hover {
	text-decoration: underline;
	cursor: pointer;
}

::-webkit-scrollbar {
	width: 9px;
}

::-webkit-scrollbar-track {
	background: transparent;
}

::-webkit-scrollbar-thumb {
	background-color: rgba(155, 155, 155, 0.5);
	border-radius: 20px;
	border-collapse: collapse;
	border: transparent;
}

main {
	min-height: calc(100vh - 70px);
	/* 設定 main 區域的最小高度，確保 footer 固定在底部 */
}

form {
	margin-left: 20px;
	margin-top: 10px;
}

#reporterId-error, #reporteeId-error, #repTitle-error, #repContent-error
	{
	color: red;
	margin-left: 130px;
	font-size: 15px;
}

table {
	border-collapse: collapse;
}

td {
	border: 1px solid;
}

.edit-post-btn a{
	margin: 0px;
}
</style>


    <style>
        * {
/*             margin: 0; */
/*             padding: 0; */
            font-family: 'Noto Sans TC', sans-serif;
        }

        main {
            min-height: calc(100vh - 70px);
            /* 設定 main 區域的最小高度，確保 footer 固定在底部 */
        }

        #latest2 a {
            color: black;
            /* 文字顏色 */
        }

        #latest a {
            color: black;
            /* 文字顏色 */
        }

        #buttons a {
            margin-right: 150px;
            /* 調整您需要的間距值 */
            margin-left: 150px;
        }

        .col:hover {
            transform: scale(1.1);
            transition: .3s;
        }

        /* 隱藏右上角icon */
        /* .icon{
                  display: none;
                } */
        .announcement-bar {
            background-color: #f8f9fa;
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        /* 彈窗的基本樣式 */
        .popup {
            display: none;
            /* 初始不顯示 */
            position: fixed;
            z-index: 1;
            /* 在其他內容之上 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            /* 背景色 */
            background-color: rgba(0, 0, 0, 0.4);
            /* 黑色背景，略透明 */
        }

        /* 彈窗內容 */
        .popup-content {
            background-color: #fefefe;
            margin: 15% auto;
            /* 15% 從上方開始 */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            /* 寬度 */
        }

        /* 關閉按鈕 */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .useshadow {
            text-shadow: 1px 1px 3px #d8d2d2, 5px 3px 0 #cfcdcd;
        }

        .custom-img-height {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }


        /* 登入後側邊漢堡選單 */
        #offcanvasBtn {
            --bs-btn-color: #fff;
            --bs-btn-bg: #abb0b7;
            --bs-btn-border-color: #abb0b7;
            --bs-btn-hover-color: #fff;
            --bs-btn-hover-bg: #787a7d;
            --bs-btn-hover-border-color: #8f9093;
            --bs-btn-focus-shadow-rgb: 49, 132, 253;
            --bs-btn-active-color: #fff;
            --bs-btn-active-bg: #787a7d;
            --bs-btn-active-border-color: #787a7d;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-btn-disabled-color: #fff;
            --bs-btn-disabled-bg: #787a7d;
            --bs-btn-disabled-border-color: #787a7d;
        }

        /* 登入前註冊按鈕 */
        .btn-primary2 {
            --bs-btn-color: #fff;
            --bs-btn-bg: #0d6efd;
            --bs-btn-border-color: #0d6efd;
            --bs-btn-hover-color: #fff;
            --bs-btn-hover-bg: #0d6efd;
            --bs-btn-hover-border-color: #0d6efd;
            --bs-btn-focus-shadow-rgb: 49, 132, 253;
            --bs-btn-active-color: #fff;
            --bs-btn-active-bg: #0d6efd;
            --bs-btn-active-border-color: #0d6efd;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-btn-disabled-color: #fff;
            --bs-btn-disabled-bg: #0d6efd;
            --bs-btn-disabled-border-color: #0d6efd;

        }


    </style>
</head>



<body>

	<form method="post" style="display: none" id="visitMemForm"
		th:action="@{/mem}">
		<input id="visitMem" type="number" th:name="memId" /> <input
			type="submit" />
	</form>

	<form method="get" style="display: none" id="visitChatForm"
		th:action="@{/member/chat}">
		<input id="visitChat" type="number" th:name="memId" /> <input
			type="submit" />
	</form>


<div style="width: 200px" class="offcanvas offcanvas-start"
     tabindex="-1" id="offcanvasExample"
     aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-body" style="padding: 0px; overflow-x: hidden">

        <div class="b-example-divider"></div>

        <div
                class="d-flex flex-column align-items-stretch flex-shrink-0 bg-white"
                style="width: 200px;">
            <a href="/member"
               class="d-flex align-items-center flex-shrink-0 p-3 link-dark text-decoration-none border-bottom">
                <svg class="bi me-2" width="30" height="24">
                    <use xlink:href="#bootstrap"/>
                </svg>
                <span class="fs-5 fw-semibold">會員首頁</span>
            </a>
            <div class="list-group list-group-flush border-bottom scrollarea">
                <a th:href="@{/member/chat}"
                   class="list-group-item list-group-item-action py-3 lh-tight"
                   aria-current="true">
                    <div
                            class="d-flex w-100 align-items-center justify-content-between">
                        <strong class="mb-1">聊天</strong>
                    </div>
                </a> <a th:href="@{/front_end/notify}"
                        class="list-group-item list-group-item-action py-3 lh-tight"
                        aria-current="true">
                <div
                        class="d-flex w-100 align-items-center justify-content-between">
                    <strong class="mb-1">通知</strong>
                </div>
            </a> <a th:href="@{/member/venOrder}"
                    class="list-group-item list-group-item-action py-3 lh-tight"
                    aria-current="true">
                <div
                        class="d-flex w-100 align-items-center justify-content-between">
                    <strong class="mb-1">場地預訂</strong>
                </div>
            </a>
                <a th:href="@{/membership/actreview}" class="list-group-item list-group-item-action py-3 lh-tight"
                   aria-current="true">
                    <div class="d-flex w-100 align-items-center justify-content-between">
                        <strong class="mb-1">活動管理</strong>
                    </div>
                </a>
            </div>
        </div>

        <div class="b-example-divider"></div>

    </div>
</div>

<div class="container">
    <header
            class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">

        <div class="after-logging" th:if="${session.memId ne null}">
            <button id="offcanvasBtn" class="btn btn-primary fa fa-bars" type="button"
                    data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample"
                    aria-controls="offcanvasExample"></button>
        </div>

        <div class="col-md-3 mb-2 mb-md-0">
            <a th:href="@{/Zuo-Huo}"
               class="d-inline-flex link-body-emphasis text-decoration-none">
                <img alt="zuo-huo" src="/front-end/zuo-huo/images/LogoName.jpg"
                     style="width: 160px;">
            </a>
        </div>
        <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0">
            <li><a th:href="@{/membership/ZuoHuo}"
                   class="nav-link px-2 link-secondary">首頁</a></li>
            <li><a th:href="@{/act/joinAct}" class="nav-link px-2 link-secondary">瀏覽活動</a></li>
            <li><a th:href="@{/act/createAct}" class="nav-link px-2 link-secondary">舉辦活動</a></li>
            <li><a th:href="@{/front_end/venue/browse}" class="nav-link px-2 link-secondary">場地租借</a></li>
            <li><a th:href="@{/faq/faqs}"
                   class="nav-link px-2 link-secondary">FAQs</a></li>
            <li><a th:href="@{/faq/faqs}"
                   class="nav-link px-2 link-secondary">關於我們</a></li>
        </ul>


        <div class="col-md-3 text-end">

            <!-- 這邊放會員登入後的選項 -->
            <div class="after-logging" th:if="${session.memId ne null}">
                <a th:href="@{/member/chat}"><i class="icon bi bi-messenger"
                   style="font-size: 28px; margin: 20px; color: #6161f2;"></i></a>

                <!-- -------------------- 通知訊息功能 下拉選單 -------------------- -->
                <i class="icon bi bi-bell-fill" type="button"
                   id="dropdownMenuButton1" data-bs-toggle="dropdown"
                   aria-expanded="false" style="font-size: 28px; color: #eded1e;"></i>

                <ul id="notify_ul" class="dropdown-menu"
                    aria-labelledby="dropdownMenuButton1">
                    <li id="notify_a1"></li>
                    <li id="notify_a2"></li>
                    <li id="notify_a3"></li>
                    <li><a id="display_all" class="dropdown-item"
                           th:href="@{/front_end/notify}">顯示全部</a></li>
                </ul>
                <!-- -------------------- 通知訊息功能 下拉選單 END -------------------- -->

                <!-- class拿掉dropdown-toggle 有問題再加回來 -->
                <i class="icon bi bi-person-circle" id="dropdownMenuLink"
                   type="button" data-bs-toggle="dropdown" aria-expanded="false"
                   style="font-size: 40px; margin: 20px;"></i>

                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                    <li><a class="dropdown-item"
                           th:href="@{/member}">個人資料</a></li>
                    <li><a id="SignOut" class="dropdown-item" th:href="@{/membership/login}">登出</a></li>
                </ul>

            </div>

            <div class="after-logging" th:unless="${session.memId ne null}">
                <button type="button" class="btn btn-outline-primary me-2">
                    <a class="nav-link" th:href="@{/membership/logging}">登入</a>
                </button>
                <button type="button" class="btn btn-primary2">
                    <a class="nav-link" th:href="@{/membership/addMembership}">註冊</a>
                </button>
            </div>
        </div>

    </header>
</div>


	<div style="width: 1000px; margin-left: 150px; margin-top: 20px"
		class="row">
		<div class="col-3" style="height: 250px">
			<img id="mem-img"
				style="width: 225px; height: 225px; overflow: hidden; border-radius: 50%">
		</div>
		<div class="col-3" style="height: 250px">
			<div class="text-start" style="margin-top: 20px">
				<h2 style="margin-left: 0px" id="mem-name"></h2>
				<h5 style="margin-left: 0px" id="mem-num-friend"></h5>
				<h5 id="mem-relation"></h5>
				<div class="curMember" style="margin-top: 10px; display: none">
					<a th:href="@{membership/getOne_For_Update}"><button
							id="mem-edit"
							style="font-size: 20px; color: green;; display: none">
							更新<i class="fa fa-edit"></i>
						</button></a>
				</div>
				<div class="visitor" style="margin-top: 10px">
					<button class="visit-relation-btn" id="visit-unfriend"
						style="display: none; font-size: 20px; color: red">
						解除好友<i class="fa fa-close"></i>
					</button>
					<button class="visit-relation-btn" id="visit-add-friend"
						style="display: none; font-size: 20px; color: green">
						加好友<i class="fas fa-user-friends"> </i>
					</button>
					<button class="visit-relation-btn" id="visit-unsend-request"
						style="display: none; font-size: 20px; color: red">
						取消請求<i class="fa fa-close"> </i>
					</button>
					<button class="visit-relation-btn" id="visit-block-member"
						style="display: none; font-size: 20px; color: red">
						封鎖<i class="fa fa-ban"></i>
					</button>
					<button class="visit-relation-btn" id="visit-unblock-member"
						style="display: none; font-size: 20px; color: red">
						解除封鎖<i class="fa fa-unlock"></i>
					</button>
				</div>
				<div class="visitor" style="margin-top: 10px">
					<button id="visit-chat-btn"
						style="font-size: 20px; color: blue; display: none">
						聊天<i class="fa fa-comments-o"></i>
					</button>

					<button id="visit-report-btn" style="font-size: 20px; color: red">
						檢舉<i class="fa fa-file"></i>
					</button>
					<span style="display:none; margin-left: 20px" id="mem-reported">檢舉正在審查中</span>
				</div>
			</div>
		</div>
		<div class="col-6 text-start" style="height: 250px">
			<h3
				style="margin-left: 0px; margin-bottom: 20px" class="text-center">
				<b>自我介紹</b>
			</h3>
			<div style="font-size: 14px; height: 200px; overflow-y: auto"
				id="mem-intro" class="text-center"></div>
		</div>
	</div>


	<ul id="member-tabs"
		style="width: 1000px; margin-left: 150px; margin-top: 30px; display: none"
		class="nav nav-tabs">
		<li id="post-tab" class="nav-item"><a style="width: 100px"
			class="nav-link active" href="#posts">貼文</a></li>
		<li id="friend-tab" class="nav-item"><a style="width: 100px"
			class="nav-link" aria-current="page" href="#friends">好友</a></li>
		<li id="request-tab" class="curMember nav-item"><a
			style="width: 100px" class="nav-link" href="#">好友請求</a></li>
		<li id="block-tab" class="curMember nav-item"><a
			style="width: 100px" class="nav-link" href="#">封鎖會員</a></li>
	</ul>


	<!-- add post modal -->
	<div class="modal fade" id="add-post-modal" data-bs-backdrop="static"
		data-bs-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg text-center">
			<div style="width: 800px" class="modal-content text-center">
				<div class="modal-header text-center">
					<div style="display: inline-block; width: 100%">
						<h5 class="modal-title" id="staticBackdropLabel">新增貼文</h5>
					</div>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body text-center">

					<div class="add-post-div" style="text-align: center">
						<form class="tinymce needs-validation">
							<input placeholder="貼文標題" id="add-post-title" maxlength="10"
								type="text" class="form-control add-input" required>
							<div id="invalid-title" data-valid="false"
								class="add-validation required invalid-feedback">必填</div>
							<textarea class="post form-control add-input" required></textarea>
							<div id="invalid-content" data-valid="false"
								class="add-validation required invalid-feedback">必填</div>
							<div style="margin-top: 20px" class="text-center">
								<input class="form-check-input" type="checkbox" value=""
									id="add-post-status"> <label style="margin-left: 10px"
									class="form-check-label" for="add-post-status">設為私人貼文</label>
							</div>
						</form>
					</div>

				</div>
				<div class="modal-footer">
					<button id="add-discard-btn" style="display: none" type="button"
						class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button id="add-clear-btn" type="reset" class="btn btn-secondary">清除</button>
					<button disabled id="add-save-btn" type="button"
						class="btn btn-primary">儲存</button>
				</div>
			</div>
		</div>
	</div>



	<div
		style="display: none; width: 1000px; margin-left: 150px; border: solid black 1px"
		id="posts" class="tab">
		<div style="background-color: yellow" class="text-center"
			id="posts-title">
			<i id="add-post" data-bs-target="#add-post-modal"
				data-bs-toggle="modal" style="font-size: 30px; color: green"
				class="curMember fa fa-plus-circle" aria-hidden="true"></i>
			<h2
				style="display: inline-block; margin-left: 20px; margin-right: 20px">貼文</h2>
			<i id="post-sort" data-order="desc" class="fa-solid fa-sort"></i>
		</div>
		<div style="width: 1000px; height: 500px; overflow-y: auto"
			id="posts-body" class="text-center"></div>
	</div>



	<div
		style="width: 1000px; margin-left: 150px; border: solid black 1px; display: none"
		id="friends" class="tab">
		<div style="background-color: yellow" class="text-center"
			id="friends-title">
			<h2
				style="display: inline-block; margin-top: 10px; margin-left: 20px; margin-right: 20px">好友</h2>
			<input type="text" id="friend-search" placeholder="搜尋好友">
			<button id="clear-friend-search">清除</button>
		</div>
		<div style="width: 1000px; height: 500px; overflow-y: auto"
			id="friends-body" class="text-center"></div>
	</div>

	<div
		style="display: none; width: 1000px; margin-left: 150px; border: solid black 1px"
		id="friend-requests" class="tab">
		<div style="background-color: yellow" class="text-center"
			id="friend-requests-title">
			<h2
				style="display: inline-block; margin-left: 20px; margin-right: 20px">好友請求</h2>
		</div>
		<div style="width: 1000px; height: 500px; overflow-y: auto"
			id="friend-requests-body" class="text-center"></div>
	</div>

	<div
		style="display: none; width: 1000px; margin-left: 150px; border: solid black 1px"
		id="blocks" class="tab">
		<div style="background-color: yellow" class="text-center"
			id="blocks-title">
			<h2
				style="display: inline-block; margin-left: 20px; margin-right: 20px">封鎖會員</h2>
		</div>
		<div style="width: 1000px; height: 500px; overflow-y: auto"
			id="blocks-body" class="text-center"></div>
	</div>


	<script th:inline="javascript">
		/*<![CDATA[*/	
	
		let members = [];
		let filteredMembers = [];
		let isSearch;
		let memId;
		let visitId;
		let memRelation;
		
		let status = /*[[${status}]]*/'';

		status = status ?? "visit";

		
		if (status == "visit"){
			memId = /*[[${rMemId}]]*/'';
			visitId = /*[[${session.memId}]]*/'';
		}
		else {
			memId = /*[[${session.memId}]]*/'';
		} 
		
		let member;
		let posts;
		let isEdit;
		let curPost;
		
		let publicPost = `<li class="status-li" style="list-style-type: none"><i class="fas fa-users dropdown-item" aria-hidden="true"><span style="margin-left:20px">公開貼文</span></i></li>`;
		let privatePost = `<li class="status-li" style="list-style-type: none"><i class="fa fa-user-secret dropdown-item" aria-hidden="true"><span style="margin-left:20px">私人貼文</span></i></li>`;
		let deletePost = `<li class="status-li" style="list-style-type: none"><i class="fa fa-trash dropdown-item" aria-hidden="true"><span style="margin-left:20px">刪除貼文</span></i></li>`;
		
		let requests;
		let blocks;
		let friends;
		
		let isBlocked = false;
		
// 		memId = 16;
// 		visitId = 19;
		
		if(!visitId){
			$(".visitor").hide();
			$(".curMember").show();
		} else{
			$(".curMember").hide();
		}
		
		/*]]>*/
	</script>

	<script>
	$(document).ready(async function(){
// 		await sendFriendRequest();
// 		await blockMember();

		await getMemReport();

		$("#posts").show();
		
		if(visitId){
			await displayRelation();
			await displayBlock();
		} else{
			$("#mem-edit").show();
			$("#member-tabs").show();
		}
		
		member = await loadMember();
		posts = await loadPosts();
		
		if(status != "visit"){
			await displayRequests();
			await displayBlocks();
		}
		
		
		let tab = window.location.hash;
		if (tab == "#friends") {
			$("#friend-tab").click();
		} 
	});
	
	</script>

	<!-- 	member page -->
	<script>
	async function getMemRelation(){
		let relation = {memIdA: visitId, memIdB: memId};
		return await fetch("/member/getRelationStatus", {
			method: "POST",
			body: JSON.stringify(relation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation.status;
		});
	}
	
	async function displayBlock(){
		let relation = {memIdA: memId, memIdB: visitId};
		let status = await fetch("/member/getRelationStatus", {
			method: "POST",
			body: JSON.stringify(relation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation.status;
		});
		if(status == 3){		
			isBlocked = true;
			$(".visit-relation-btn").hide();
			$("#visit-block-member").show();
			$("#visit-chat-btn").hide();
			$("#mem-relation").text(`您被${$("#mem-name").text()}封鎖`);
			$("#posts").hide();
		} else{
			await displayFriends();
			$("#member-tabs").show();
		}
	}
	
	async function displayRelation(){
		memRelation = await getMemRelation();

		if(memRelation == 0){
			$(".visit-relation-btn").hide();
			$("#visit-add-friend").show();
			$("#visit-block-member").show();
			$("#mem-relation").text("");
			$("#visit-chat-btn").show();
		} else if(memRelation == 1){
			$(".visit-relation-btn").hide();
			$("#visit-unsend-request").show();
			$("#mem-relation").text("已發送好友請求");
			$("#visit-chat-btn").show();
		} else if(memRelation == 2){
			$(".visit-relation-btn").hide();
			$("#visit-unfriend").show();
			$("#mem-relation").text("已是好友");
			$("#visit-chat-btn").show();
		} else if(memRelation == 3){
			$(".visit-relation-btn").hide();
			$("#visit-unblock-member").show();
			$("#mem-relation").text("已封鎖");
			$("#visit-chat-btn").hide();
		}
		if(isBlocked){
			$("#visit-add-friend").hide();
			$("#visit-chat-btn").hide();
		}
	}
	
	$(document).on("click", ".visit-mem", function(){
		$("#visitMem").val($(this).attr("data-id"));
		$("#visitMemForm").submit();
	});
	
	$("#visit-chat-btn").on("click", function(){
		$("#visitChat").val(memId);
		$("#visitChatForm").submit();
	});
	
	$("#visit-unfriend").on("click", async function(){
		let memRelation = {memIdA: visitId, memIdB: memId};
		
		await fetch("/member/unfriend", {
			method: "POST",
			body: JSON.stringify(memRelation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
		
		await displayRelation();
		await displayFriends();
	});
	
	$("#visit-add-friend").on("click", async function(){		
		await sendFriendRequest();
		await displayRelation();
	});
	
	$("#visit-unsend-request").on("click", async function(){	
		let memRelation = {memIdA: visitId, memIdB: memId};
		await fetch("/member/unsendRequest", {
			method: "POST",
			body: JSON.stringify(memRelation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
		await displayRelation();
	});
	
	$("#visit-block-member").on("click", async function(){	
		await blockMember();
		await displayRelation();
	});
	
	$("#visit-unblock-member").on("click", async function(){
		let memRelation = {memIdA: visitId, memIdB: memId};
		await fetch("/member/unblock", {
			method: "POST",
			body: JSON.stringify(memRelation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
		await displayRelation();
	});
	
	</script>


	<!-- 	nav item tabs -->
	<script>
	$(".nav-item").on("click", function(){
		$(".nav-item .nav-link").removeClass("active");
		$(this).find(".nav-link").addClass("active");
		$("#friend-search").val("");
		return false;
	});
	
	$("#friend-tab").on("click", async function(){
		await displayFriends();
		$(".tab").hide();
		$("#friends").show();
	});
	
	$("#post-tab").on("click", function(){
		$(".tab").hide();
		$("#posts").show();
	});
	
	$("#request-tab").on("click", async function(){
		await displayRequests();
		$(".tab").hide();
		$("#friend-requests").show();
	});
	
	$("#block-tab").on("click", async function(){
		await displayBlocks();
		$(".tab").hide();
		$("#blocks").show();
	});
	
	
	$(document).on("click", ".mem-chat-btn", function(){
		let rMemId = $(this).attr("data-id");
		$("#visitChat").val(rMemId);
		$("#visitChatForm").submit();
	});
	
	
	</script>


	<!-- 	friend requests -->
	<script>
	
	async function sendFriendRequest(){
		let memRelation = {memIdA: visitId, memIdB: memId};
		return await fetch("/member/sendFriendRequest", {
			method: "POST",
			body: JSON.stringify(memRelation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
	}
	
	async function getFriendRequests(){
		return await fetch("/member/getFriendRequests", {
			method: "POST",
			body: JSON.stringify({memId: memId})
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
	}
	
	async function displayRequests(){
		requests = await getFriendRequests();
		await getFriends();
    	
    	if(!requests.length){
    		$("#friend-requests-body").html("");
    		$("#friend-requests-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>暫無請求</h3></div>`);
    		return;
    	}
    	
		$('#friend-requests').pagination({
		    dataSource: requests,
		    pageSize: 5,
		    callback: async function(requests, pagination) {
		    	$("#friend-requests-body").html("");
// 		    	if(!requests.length){
// 		    		$("#friend-requests-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>暫無請求</h3></div>`);
// 		    	}
		        for (request of requests) {
					await fetch("/member/getById", {
						method: "POST",
						body: JSON.stringify({memId: request.memIdA})
					}).then(function(response){
						return response.json();
					}).then(function(mem){
												
				let html = `<div style="width:500px; margin-top: 100px; margin-bottom: 50px; margin-left:250px"
				class="row text-center mem-div" data-id="${mem.memId}">
				<div class="col-4" style="height: 150px">
					<img class="request-mem-img" src="${mem.memPic? 'data:img/png;base64,' + mem.memPic: '/front-end/01/images/notfind.jpg'}"
						style="width: 150px; height: 150px; overflow: hidden; border-radius: 50%">
				</div>
				<div class="col-4" style="height: 150px">
					<div class="text-center" style="margin-top: 50px">
						<h3 class="visit-mem request-mem-name" data-id="${mem.memId}">${mem.memUsername}</h3>			
					</div>
				</div>
				<div class="col-4" style="height: 150px">
					<div style="margin-top:20px">
						<div class="text-center">
							<button class="accept-request-btn" data-id="${mem.memId}" style="font-size: 24px; color: green">接受請求</button>
						</div>
						<div style="margin-top:20px" class="text-center">
							<button data-id="${mem.memId}" class="mem-chat-btn" style="font-size: 24px; color: blue">聊天</button>
						</div>
					</div>
				</div>	
			</div>`;
												
						$("#friend-requests-body").append(html);
						
					});
		        }
		    }
		});
	}
	
	
	$(document).on("click", ".accept-request-btn", async function(){
		let friendId = $(this).attr("data-id");
		let memRelation = {memIdA: memId, memIdB: friendId};
		await fetch("/member/acceptFriendRequest", {
			method: "POST",
			body: JSON.stringify(memRelation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){

		});
		
		await displayRequests();
	});

	
	
	</script>


	<!-- 	block members -->
	<script>
	


	async function blockMember(){
		let memRelation = {memIdA: visitId, memIdB: memId};
		return await fetch("/member/blockMember", {
			method: "POST",
			body: JSON.stringify(memRelation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
	}
	
	async function getBlockedMembers(){
		return await fetch("/member/getBlockedMembers", {
			method: "POST",
			body: JSON.stringify({memId: memId})
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
	}
	
	async function displayBlocks(){
		blocks = await getBlockedMembers();
		
    	if(!blocks.length){
    		$("#blocks-body").html("");
    		$("#blocks-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>無封鎖會員</h3></div>`);
    		return;
    	}
    	
		$('#blocks').pagination({
		    dataSource: blocks,
		    pageSize: 5,
		    callback: async function(blocks, pagination) {
		    	$("#blocks-body").html("");
// 		    	if(!blocks.length){
// 		    		$("#blocks-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>無封鎖會員</h3></div>`);
// 		    	}
		        for (block of blocks) {
					await fetch("/member/getById", {
						method: "POST",
						body: JSON.stringify({memId: block.memIdB})
					}).then(function(response){
						return response.json();
					}).then(function(mem){
												
				let html = `<div style="width:500px; margin-top: 100px; margin-bottom: 50px; margin-left:250px"
				class="row text-center mem-div" data-id="${mem.memId}">
				<div class="col-4" style="height: 150px">
					<img class="block-mem-img" src="${mem.memPic? 'data:img/png;base64,' + mem.memPic: '/front-end/01/images/notfind.jpg'}"
						style="width: 150px; height: 150px; overflow: hidden; border-radius: 50%">
				</div>
				<div class="col-4" style="height: 150px; margin-top: 50px">
					<div class="text-center">
						<h3 class="visit-mem block-mem-name" data-id="${mem.memId}">${mem.memUsername}</h3>
					</div>
				</div>				
				<div class="col-4" style="height: 150px; margin-top: 20px">
					<div class="text-center">
						<div>
							<button id="unblock${mem.memId}" class="unblock-btn" data-id="${mem.memId}" data-userName="${mem.memUsername}" style="font-size: 24px; color: red">解除封鎖</button>
						</div>
						<div style="margin-top: 20px">
							<button class="mem-chat-btn" data-id="${mem.memId}" style="font-size: 24px; color: blue">聊天</button>
						</div>
					</div>
				</div>	
			</div>`;
												
						$("#blocks-body").append(html);
						
				        let options = {
				        		title: null,
				        	    confirm: `解除對${mem.memUsername}的封鎖？`,
				        	    buttonConfirm: `<span class="confirmUnblock" id="confirmUnblock${mem.memId}" data-id="${mem.memId}">確認</span>`,	        	 
				        	    buttonCancel: "取消",
				        	    header: null    	    
				        	};
				        	let unblockBtn = document.getElementById(`unblock${mem.memId}`);
				        	window.powerButtons('confirm', unblockBtn, options);
						
					});
		        }
		    }
		});
	}
	
	
	$(document).on("click", ".button0", async function(){
		if(!$(this).find(".confirmUnblock").length) return false;
		
		let unblockId = $(this).find(".confirmUnblock").attr("data-id");
		
		blocks = blocks.filter(block => block.memIdB != unblockId);

		let memRelation = {memIdA: memId, memIdB: unblockId};
		
		await fetch("/member/unblock", {
			method: "POST",
			body: JSON.stringify(memRelation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
		
		await displayBlocks();
	});

	

	
	
	</script>


	<!-- 	friends -->
	<script>
	
	$("#friend-search").on("input", async function(){
		let input = $(this).val().toLowerCase();
		isSearch = true;
		filteredMembers = members.filter(member => member.memUsername.toLowerCase().startsWith(input));
		await displayFriends();
		// 		$(".friend-div").each(function(){
// 			if($(this).find(".unfriend-mem-name").text().toLowerCase().startsWith(input)){
// 				$(this).show();
// 			} else{
// 				$(this).hide();
// 			}
// 		});
	});
	
	$("#clear-friend-search").on("click", async function(){
		$("#friend-search").val("");
		await displayFriends();
	});
	
	async function getFriends(){
		return await fetch("/member/getFriends", {
			method: "POST",
			body: JSON.stringify({memId: memId})
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			$("#mem-num-friend").text(`${relation.length} 好友`);
			return relation;
		});
	}
	
	async function displayFriends(){
		friends = await getFriends();
		
		if(isSearch){
	    	if(!filteredMembers.length){
	    		$("#friends-body").html("");
	    		$("#friends-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>無搜尋到的好友</h3></div>`);
		    	isSearch = false;
	    		return;
	    	}
		} else{
	    	if(!friends.length){
	    		$("#friends-body").html("");
	    		$("#friends-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>暫無好友</h3></div>`);
		    	isSearch = false;
	    		return;
	    	}
		}

		$('#friends').pagination({
		    dataSource: friends,
		    pageSize: 10,
		    callback: async function(friends, pagination) {
		    	$("#friends-body").html("");

		    	if(isSearch){

// 			    	if(!filteredMembers.length){
// 			    		$("#friends-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>無搜尋到的好友</h3></div>`);
// 			    	}
			        for (mem of filteredMembers) {		        	
													
					let html = `<div style="width:500px; margin-top: 100px; margin-bottom: 50px; margin-left:250px"
					class="row text-center mem-div friend-div" data-id="${mem.memId}" data-userName="${mem.memUsername}">
					<div class="col-4" style="height: 150px">
						<img class="friend-mem-img" src="${mem.memPic? 'data:img/png;base64,' + mem.memPic: '/front-end/01/images/notfind.jpg'}"
							style="width: 150px; height: 150px; overflow: hidden; border-radius: 50%">
					</div>
					<div class="col-4" style="height: 150px">
						<div style="margin-top:20px" class="text-center">
							<h3 class="visit-mem unfriend-mem-name" data-id="${mem.memId}">${mem.memUsername}</h3>				
						</div>
					</div>	
					<div class="col-4" style="height: 150px">
						<div style="margin-top:20px" class="text-center">
							<div><button id="unfriend${mem.memId}" class="curMember block-btn" data-id="${mem.memId}" style="font-size: 24px; color: red; display:${visitId? 'none': ''}">解除好友</button></div>
							<div style="margin-top:20px"><button class="curMember mem-chat-btn" data-id="${mem.memId}" style="font-size: 24px; color: blue; display:${visitId? 'none': ''}">聊天</button></div>											
						</div>
					</div>	
				</div>`;
													
							$("#friends-body").append(html);
							
					        let options = {
					        		title: null,
					        	    confirm: `解除與${mem.memUsername}的好友關係？`,
					        	    buttonConfirm: `<span class="confirmUnfriend" id="confirmUnfriend${mem.memId}" data-id="${mem.memId}">確認</span>`,	        	 
					        	    buttonCancel: "取消",
					        	    header: null    	    
					        	};
					        	let unfriendBtn = document.getElementById(`unfriend${mem.memId}`);
					        	window.powerButtons('confirm', unfriendBtn, options);							
			        }
		    	}
		    	else{
// 			    	if(!friends.length){
// 			    		$("#friends-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>暫無好友</h3></div>`);
// 			    	}
		    	members = [];
		        for (friend of friends) {		        	
					await fetch("/member/getById", {
						method: "POST",
						body: JSON.stringify({memId: friend.memIdB})
					}).then(function(response){
						return response.json();
					}).then(function(mem){
						members.push(mem);
												
				let html = `<div style="width:500px; margin-top: 100px; margin-bottom: 50px; margin-left:250px"
				class="row text-center mem-div friend-div" data-id="${mem.memId}" data-userName="${mem.memUsername}">
				<div class="col-4" style="height: 150px">
					<img class="friend-mem-img" src="${mem.memPic? 'data:img/png;base64,' + mem.memPic: '/front-end/01/images/notfind.jpg'}"
						style="width: 150px; height: 150px; overflow: hidden; border-radius: 50%">
				</div>
				<div class="col-4" style="height: 150px">
					<div style="margin-top:20px" class="text-center">
						<h3 class="visit-mem unfriend-mem-name" data-id="${mem.memId}">${mem.memUsername}</h3>				
					</div>
				</div>	
				<div class="col-4" style="height: 150px">
					<div style="margin-top:20px" class="text-center">
						<div><button id="unfriend${mem.memId}" class="curMember block-btn" data-id="${mem.memId}" style="font-size: 24px; color: red; display:${visitId? 'none': ''}">解除好友</button></div>
						<div style="margin-top:20px"><button class="curMember mem-chat-btn" data-id="${mem.memId}" style="font-size: 24px; color: blue; display:${visitId? 'none': ''}">聊天</button></div>											
					</div>
				</div>	
			</div>`;
												
						$("#friends-body").append(html);
						
				        let options = {
				        		title: null,
				        	    confirm: `解除與${mem.memUsername}的好友關係？`,
				        	    buttonConfirm: `<span class="confirmUnfriend" id="confirmUnfriend${mem.memId}" data-id="${mem.memId}">確認</span>`,	        	 
				        	    buttonCancel: "取消",
				        	    header: null    	    
				        	};
				        	let unfriendBtn = document.getElementById(`unfriend${mem.memId}`);
				        	window.powerButtons('confirm', unfriendBtn, options);
						
					});
		        }
		    }
		    	isSearch = false;
		    }
		});
	}
	
	
	$(document).on("click", ".button0", async function(){
		if(!$(this).find(".confirmUnfriend").length) return false;
		
		let unfriendId = $(this).find(".confirmUnfriend").attr("data-id");
		
		friends = friends.filter(friend => friend.memIdB != unfriendId);
		
		let memRelation = {memIdA: memId, memIdB: unfriendId};
		
		await fetch("/member/unfriend", {
			method: "POST",
			body: JSON.stringify(memRelation)
		}).then(function(response){
			return response.json();
		}).then(function(relation){
			return relation;
		});
		
		await displayFriends();
	});

	

	
	
	</script>



	<!-- load member and posts -->
	<script>
		async function loadMember(){
			return await fetch("/member/getById", {
				method: "POST",
				body: JSON.stringify({memId: memId})
			}).then(function(response){
				return response.json();
			}).then(function(mem){
				$("#mem-img").attr("src",mem.memPic? "data:image/png;base64," + mem.memPic: "/front-end/01/images/notfind.jpg");
				$("#mem-name").text(mem.memUsername);
				$("#mem-intro").text(mem.memIntro);
				if(!$("#mem-intro").text()){
					$("#mem-intro").append(`<div style="margin-left: 125px; margin-top:50px; margin-bottom:50px"><h3>暫無自我介紹</h3></div>`);
		    	}
				return mem;
			});
		}	
			
		async function loadPosts(){
			return await fetch("/member/getPosts", {
				method: "POST",
				body: JSON.stringify({memId: memId})
			}).then(function(response){
				return response.json();
			}).then(async function(posts){
				posts.sort((a, b) => b.postTime.localeCompare(a.postTime));
				await displayPosts(posts);
				return posts;
			});
		}		
	
	
	async function displayPosts(posts){
		if(visitId){
			posts = posts.filter(post => post.postStatus != 2);
		}
    	if(!posts.length){
    		$("#posts-body").html("");
    		$("#posts-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>暫無貼文</h3></div>`);
    		return;
    	}
		$('#posts').pagination({
		    dataSource: posts,
		    pageSize: 3,
// 		    showSizeChanger: true,
// 		    sizeChangerOptions: [2, 5, 10, 20, 50, 100],
		    callback: async function(posts, pagination) {
		    	$("#posts-body").html("");
		    	
// 		    	if(!posts.length){
// 		    		$("#posts-body").append(`<div style="margin-top:200px; margin-bottom:50px"><h3>暫無貼文</h3></div>`);
// 		    		return;
// 		    	}
		    	
		        for (post of posts) {
		        let html = `<div class="post" data-id="${post.postId}"><div class="row"><div class="post-time col-6 text-start"></div><div style="display:${visitId? '': 'none'}" data-id="${post.postId}" class="post-report-btn col-6 text-end"><button style="display:none; font-size: 20px; color: red">檢舉<i class="fa fa-file"></i></button><span class="post-reported" id="post-reported${post.postId}" style="display:none">檢舉正在審查中</span></div><div style="display:${visitId? 'none': ''}" class="post-status col-6 text-end">${post.postStatus}</div></div><div class="post-title" style="width: 750px"><h3 class="text-center">${post.postTitle}</h3></div><div style="width: 750px" class="post-content text-center">${post.postContent}</div><div class="row"><div class="col-6 text-start"><button style="display:${visitId? 'none': ''}" data-bs-target="#add-post-modal" data-bs-toggle="modal" class="edit-post-btn" data-post="${post.postId}"><i class="fa fa-edit"></i></button></div><div class="col-6 text-end"><button style="display:${visitId? 'none': ''}" class="delete-post-btn" id="deletePost${post.postId}"><i class="fa fa-trash" aria-hidden="true"></button></div></div></div>`;
		        $("#posts-body").append(html);
		        displayTime(post.postId, post.postTime);
		        displayStatus(post.postId, post.postStatus);
		        
		        let options = {
		        		title: null,
		        	    confirm: `刪除這篇貼文？`,
		        	    buttonConfirm: `<span class="confirmDeletePost" id="confirmDelete${post.postId}" data-post="${post.postId}">確認</span>`,	        	 
		        	    buttonCancel: "取消",
		        	    header: null    	    
		        	};
		        	let deleteBtn = document.getElementById(`deletePost${post.postId}`);
		        	window.powerButtons('confirm', deleteBtn, options);
	        	
		        }
				await getPostReports();
		    }
		
		});
		
		}
	
	$(document).on("click", ".button0", async function(){
		if(!$(this).find(".confirmDeletePost").length) return false;
		
		let postId = $(this).find(".confirmDeletePost").attr("data-post");
		
		let updatedPost = posts.filter(post => post.postId == postId)[0];
		updatedPost.postStatus = 3; 
		posts = posts.filter(post => post.postId != postId);
		
		await displayPosts(posts);

		await fetch("/member/editPost", {
			method: "POST",
			body: JSON.stringify(updatedPost)
		}).then(function(response){
			return response.json();
		}).then(function(post){
			return post;
		});
	});
	
	</script>


	<!-- Edit Posts -->
	<script>
$(document).on("click", ".edit-post-btn", function() {
	isEdit = true;
	$("#add-post-modal .modal-title").text("修改貼文");
	let postId = $(this).attr("data-post");
	$("#add-post-modal").find("textarea.post").html("");
    openEditor($("#add-post-modal"), true, postId);
});

</script>

	<!-- Add posts -->
	<script>


        function openEditor(div, edit, postId = null) {
            div.find("textarea.post").tinymce({
            	branding: false,
                height: 500,
                width: 750,
                menubar: true,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'charmap', 'preview',
                    'anchor', 'searchreplace', 'visualblocks', 'fullscreen',
                    'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount', 'table'
                ],
                toolbar: 'undo redo | blocks | bold italic backcolor forecolor| ' +
                    'alignleft aligncenter alignright alignjustify | ' +
                    'bullist numlist table outdent indent | removeformat | code | help', 
                setup: function(editor) {
                    editor.on('init', function(e) {
                    	if(edit){
                    		
                    		let post = posts.filter(post => post.postId == postId)[0];
                    		curPost = post;
                    		$("#add-post-title").val(post.postTitle);
                    		$("#add-save-btn").prop("disabled", false);
                    		tinymce.activeEditor.setContent(post.postContent);	
                    		$("#add-post-status").prop("checked", post.postStatus == 2);
                    		$(".add-validation").attr("data-valid", true);
                    	}
                    });
                    
                    editor.on("focus", function(){
                    	$("#add-save-btn").prop("disabled", true);
                    });
                    
                    editor.on('blur', function (e) {
                    	if(tinymce.activeEditor.getContent({ format: "text" }).trim()){
                    		$("#invalid-content").hide();
                    		$("#invalid-content").attr("data-valid", "true");
                    		if(!$(`.add-validation[data-valid='false']`).length){
                        		$("#add-save-btn").attr("disabled", false);
                    		}
                    	} else{
                    		$("#invalid-content").show();
                    		$("#invalid-content").attr("data-valid", "false");
                        	$("#add-save-btn").attr("disabled", true);
                    	}
                      });
                }
            });
        }
        
        async function displayNewPost(post) {
        	posts.push(post);
        	posts.sort((a, b) => b.postTime.localeCompare(a.postTime));
        	await displayPosts(posts);
        	$("#post-sort").attr("data-order", "desc");
        }


        $("#add-save-btn").on("click", async function() {
			// save to redis and get post including post id, datetime using fetch
			
			let newPost = {memId: memId, postTitle: $("#add-post-title").val(), postContent: tinymce.activeEditor.getContent(), postStatus: $("#add-post-status").is(':checked')? "2": "1"};

			if(!isEdit){
			newPost = await fetch("/member/addPost", {
				method: "POST",
				body: JSON.stringify(newPost)
			}).then(function(response){
				return response.json();
			}).then(function(post){
				return post;
			});

            await displayNewPost(newPost);
			} else{	
				curPost.postTitle = $("#add-post-title").val();
				curPost.postContent = tinymce.activeEditor.getContent();
				curPost.postStatus = $("#add-post-status").is(':checked')? "2": "1";				
				posts.some(function(post){
					if(post.postId == curPost.postId){
						post.postTitle = curPost.postTitle;
						post.postContent = curPost.postContent;
						post.postStatus = curPost.postStatus; 
						return true;
					}
				});
				
				await fetch("/member/editPost", {
					method: "POST",
					body: JSON.stringify(curPost)
				}).then(function(response){
					return response.json();
				}).then(function(post){
					return post;
				});				
			}
			
			await displayPosts(posts);
            $("#add-discard-btn").click();
            
        });

        $("#add-post").on("click", function() {
        	isEdit = false;
        	$("#add-post-modal .modal-title").text("新增貼文");
        	$("#add-post-modal").find("textarea.post").html("");
            openEditor($("#add-post-modal"), false);
        });
        
        $("#add-post-title").on("focus", function(){
        	$("#add-save-btn").prop("disabled", true);
        });
        
        
        $("#add-post-title").on('blur', function (e) {
        	if($(this).val().trim()){
        		$("#invalid-title").hide();
        		$("#invalid-title").attr("data-valid", "true");
        		if(!$(`.add-validation[data-valid='false']`).length){
            		$("#add-save-btn").attr("disabled", false);
        		}
        	} else{
        		$("#invalid-title").show();
        		$("#invalid-title").attr("data-valid", "false");
            	$("#add-save-btn").attr("disabled", true);
        	}
          });
        	
 
    </script>





	<script>
function displayTime(id, datetime){
	if(!datetime) return;

	var today = new Date();
	today = new Date(today = today - (today.getTimezoneOffset() * 60000));
	today = today.toISOString().substring(0, 10).toString();
	let date = datetime.substring(0,10);
	let time = datetime.substring(11,16);
	let hour = parseInt(time.substring(0,2), 10);
	if(hour < 12){
		if(hour == 0) time = "12" + time.substring(2);
		time = "上午 " + time; 
	} else{
		hour = hour % 12;
		if(hour == 0) hour = 12;
		time = "下午 " + hour + time.substring(2); 
	}
	$(`.post[data-id='${id}']`).find(".post-time").html("");
	if(date == today){
		$(`.post[data-id='${id}']`).find(".post-time").text(time);
	} else{
		let dateString = date + " " + time;
		$(`.post[data-id='${id}']`).find(".post-time").text(dateString);
	}
}

function displayStatus(id, status){
	
	let html = `<div class="dropdown">
		  <button class="status-btn ${status == 1? 'fas fa-users': 'fa fa-user-secret'} btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton${id}" data-bs-toggle="dropdown" aria-expanded="false">
	   
	  </button>
	  <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton${id}">
	  </ul>
	</div>`;
	$(`.post[data-id='${id}']`).find(".post-status").html(html);
	if(status == 1){
		$(`.post[data-id='${id}']`).find(".dropdown-menu").append(privatePost);
	} else{
		$(`.post[data-id='${id}']`).find(".dropdown-menu").append(publicPost);
	}
// 	$(`.post[data-id='${id}']`).find(".dropdown-menu").append(deletePost);
}

$(document).on("click", "li.status-li", async function(){
	let postId = $(this).closest(".post").attr("data-id");
	let status;
	if($(this).find(".dropdown-item").hasClass("fa-users")){	
		status = 1;
		$(this).closest(".dropdown").find(".status-btn").removeClass("fa fa-user-secret");
		$(this).closest(".dropdown").find(".status-btn").addClass("fas fa-users");
		let dropdownMenu = $(this).closest(".dropdown-menu");
		dropdownMenu.html(privatePost);
	} else if($(this).find(".dropdown-item").hasClass("fa-user-secret")){
		status = 2;
		$(this).closest(".dropdown").find(".status-btn").removeClass("fas fa-users");
		$(this).closest(".dropdown").find(".status-btn").addClass("fa fa-user-secret");
		let dropdownMenu = $(this).closest(".dropdown-menu");
		dropdownMenu.html(publicPost);
	} 
		
	let updatedPost;
	posts.some(function(post){
		if(post.postId == postId){
			post.postStatus = status; 
			updatedPost = post;
			return true;
		}
	});
	
	await fetch("/member/editPost", {
		method: "POST",
		body: JSON.stringify(updatedPost)
	}).then(function(response){
		return response.json();
	}).then(function(post){
		return post;
	});
	
})


$(document).on("click", "#post-sort", async function(){
	if($(this).attr("data-order") == "asc"){
		posts.sort((a, b) => b.postTime.localeCompare(a.postTime));
		await displayPosts(posts);
		$(this).attr("data-order", "desc");
	} else{
		posts.sort((a, b) => a.postTime.localeCompare(b.postTime));
		await displayPosts(posts);
		$(this).attr("data-order", "asc");
	}
});

$("#add-clear-btn").on("click", function(){
	clearAddPost();
});

function clearAddPost(){

	$("#add-post-title").val("");
	$("#add-post-status").prop('checked', false);
	tinymce.activeEditor.setContent("");
	$("#invalid-title").hide();
	$("#invalid-title").attr("data-valid", "false");
	$("#invalid-content").hide();
	$("#invalid-content").attr("data-valid", "false");
	$("#add-save-btn").attr("disabled", true);
	
	if(isEdit){
		$("#add-save-btn").attr("disabled", false);
		$("#add-post-title").val(curPost.postTitle);
		$("#add-post-status").prop('checked', curPost.postStatus == 2);
		tinymce.activeEditor.setContent(curPost.postContent);
	} 
	
}

$("#add-post-modal").on("hidden.bs.modal", function () {
	isEdit = false;
	clearAddPost();
    tinymce.activeEditor.destroy();
});

</script>
  
	<!-- 彈窗 -->
	<div class="modal fade" id="insertModal" tabindex="-1" role="dialog"
		aria-labelledby="insertModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">

				<div class="modal-header text-center">
					<h3 style="width: 100%" class="modal-title text-center"
						id="reportTitle">會員檢舉</h3>
					<button style="display: none" type="button"
						id="mem-report-btn-close" class="btn-close"
						data-bs-dismiss="modal" aria-label="Close"></button>
				</div>

				<div class="modal-body">

					<form id="memReportForm" method="post"
						enctype="multipart/form-data">

						<div>
							<label>檢舉標題<font color="red"><b>*</b></font></label> <input
								id="repTitle" type="text" class="mem-report-input" /><br /> <span
								class="error" id="repTitle-error"></span><br>
						</div>

						<div>
							<label>檢舉內容<font color="red"><b>*</b></font></label>
							<textarea class="mem-report-input" id="repContent" rows="4"
								cols="50" style="resize: both;"></textarea>
							<br /> <span class="error" id="repContent-error"></span><br>
						</div>

						<div>
							<label>檢舉圖片</label><input class="mem-report-input" type="file"
								id="registerRepPic" onclick="previewImage()" multiple="multiple" />
							<span class="error" id="repPic.errors"></span> <br> <span
								class="error error-message" id="repPic-error"></span><br>
							<div id="blob_holder"></div>
						</div>
						<br>


						<div>
							<div></div>
							<div class="text-end">
								<button type="reset" class="btn btn-secondary"
									id="mem-report-reset">清除</button>
								<button type="submit" class="btn btn-primary"
									id="mem-report-submit">送出檢舉</button>
							</div>
							<div></div>
						</div>
					</form>
				</div>

				<br>

			</div>
		</div>
	</div>


	<script>

let reportType;
let fileByteArray = [];
let blob_holder = document.querySelector("#blob_holder");

$("#visit-report-btn").click(function() {
	reportType = "member";
	$("#mem-report-reset").click();
	$("#reportTitle").text("會員檢舉");
	$("#insertModal").modal("show");
});

$("#mem-report-reset").on("click", function(){
	$(".error").hide();
	blob_holder.innerHTML = "";
});

$("#insertModal").on("hidden.bs.modal", function () {
	$("#mem-report-reset").click();
});

//照片上傳-預覽用
var filereader_support = typeof FileReader != 'undefined';
if (!filereader_support) {

}
acceptedTypes = {
	'image/png' : true,
	'image/jpeg' : true,
	'image/gif' : true
};
function previewImage() {

	var upfile1 = document.getElementById("registerRepPic");
	upfile1.addEventListener("change", function(event) {
		var files = event.target.files || event.dataTransfer.files;
		for (var i = 0; i < files.length; i++) {
			previewfile(files[i]);
		}
	}, false);

}
function previewfile(file) {

	if (filereader_support === true
			&& acceptedTypes[file.type] === true) {
		var reader = new FileReader();
		reader.onload = function(event) {
			var image = new Image();
			image.src = event.target.result;
			image.width = 180;
			// 					image.height =180;
			image.border =0;
			if (blob_holder.hasChildNodes()) {
				blob_holder.removeChild(blob_holder.childNodes[0]);
			}
			blob_holder.appendChild(image);
			
		       fileByteArray = [];			
	  
		       var binaryString = atob(image.src.split("base64,")[1]);

		       fileByteArray = new Uint8Array(binaryString.length);
		       for (var i = 0; i < binaryString.length; i++) {
		    	   fileByteArray[i] = binaryString.charCodeAt(i);
		       }

		};
		reader.readAsDataURL(file);
		document.getElementById('mem-report-submit').disabled = false;
	} else {
		blob_holder.innerHTML = "<div  style='text-align: left;'>"
				+ "● filename: "
				+ file.name
				+ "<br>"
				+ "● ContentTyp: "
				+ file.type
				+ "<br>"
				+ "● size: "
				+ file.size
				+ "bytes"
				+ "<br>"
				+ "● 上傳ContentType限制: <b> <font color=red>image/png、image/jpeg、image/gif </font></b></div>";
		document.getElementById('mem-report-submit').disabled = true;
	}
}
</script>

<script>

// form submission and validation
$(document).ready(function(){
	$("#memReportForm").submit(async function(event){
		event.preventDefault();

		let hasErrors = false;
		
		var repTitle = $("#repTitle").val();
		if(repTitle.length < 1){
			$("#repTitle-error").text("請輸入檢舉標題").show();
			hasErrors = true;
		}else{
			$("#repTitle-error").hide();
		}
		
		var repContent = $("#repContent").val();
		if(repContent.length < 1){
			$("#repContent-error").text("請輸入檢舉內容").show();
			hasErrors = true;
		}else{
			$("#repContent-error").hide();
		}
		
		if(!hasErrors){
			if(reportType == "member"){
				await reportMember();
				await getMemReport();
			} else if(reportType == "post"){
				await reportPost();
			}
			$("#mem-report-btn-close").click();
		}		
		
	});
});



	async function reportMember(){
		let memReport = {reporterId: visitId, reporteeId: memId, repTitle: $("#repTitle").val(), repContent: $("#repContent").val(), repPic: fileByteArray && fileByteArray.length ? Array.from(fileByteArray) : null};
		return await fetch("/memReport/insert", {
			method: "POST",
			body: JSON.stringify(memReport)
		}).then(function(response){
			return response.json();
		}).then(function(report){
			return report;
		});
	}
</script>



<!-- post report -->
<script>
let postId;

	$(document).on("click", "div.post-report-btn button", function() {
		reportType = "post";
		postId = $(this).closest("div.post-report-btn").attr("data-id");
		$("#mem-report-reset").click();
		$("#reportTitle").text("貼文檢舉");
		$("#insertModal").modal("show");
	});
	
	async function reportPost(){
		let postReport = {memId: visitId, reporteeId: memId, postId: postId, repTitle: $("#repTitle").val(), repContent: $("#repContent").val(), repPic: fileByteArray && fileByteArray.length ? Array.from(fileByteArray) : null};
		return await fetch("/postReport/insertPost", {
			method: "POST",
			body: JSON.stringify(postReport)
		}).then(function(response){
			return response.json();
		}).then(async function(report){
			await loadPosts();
			return report;
		});
	}


</script>


<!-- check if member has already been reported -->
<script>
async function getMemReport(){
	if(!visitId) return;
	let memReport = {reporterId: visitId, reporteeId: memId};
	return await fetch("/memberreport/getReport", {
		method: "POST",
		body: JSON.stringify(memReport)
	}).then(function(response){
		return response.json();
	}).then(function(report){
		if(report){
			$("#visit-report-btn").hide();
			$("#mem-reported").show();
		}
		return report;
	}).catch(error => {
	  });
}


</script>


<!-- check if post has already been reported -->
<script>
async function getPostReports(){
	if(!visitId) return;
	let postReport = {memId: visitId, reporteeId: memId};
	return await fetch("/postreport/getReport", {
		method: "POST",
		body: JSON.stringify(postReport)
	}).then(function(response){
		return response.json();
	}).then(function(reports){
		$(".post-report-btn button").show();
		if(reports){
			for(report of reports){
				let postReportBtn = $(`.post-report-btn[data-id='${report.postId}']`).first();
				postReportBtn.find("button").hide();
				postReportBtn.find(".post-reported").show();				
			}
		}
		return reports;
	}).catch(error => {
	  });
}


</script>





</body>
</html>