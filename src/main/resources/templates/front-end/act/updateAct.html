<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>修改活動</title>
    <!-- 引入 Bootstrap CSS 文件 -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link href="https://cdn.jsdelivr.net/npm/paginationjs@2.6.0/dist/pagination.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/front-end/zuo-huo/css/notify.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<style>
/* 导入Google字体 */
@import
	url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap')
	;

/* 设置全局字体 */
body {
	font-family: 'Roboto', sans-serif;
	font-size: 16px; /* 标准字体大小 */
	line-height: 1.6; /* 行高 */
	color: #333; /* 字体颜色 */
	background: #f5f5f5; /* 浅灰色背景 */
	
}

/* 调整标题的样式 */
h1, h2, h3, h4, h5, h6 {
	font-weight: 700; /* 字体加粗 */
	margin-bottom: 0.5em; /* 下边距 */
}

/* 调整段落的样式 */
p {
	margin-bottom: 1em; /* 下边距 */
}
/* 可以根据需要调整其他元素的样式 */
main {
	min-height: calc(100vh - 70px);
}

form {
	display: flex;
	flex-direction: column;
}

form label {
	margin-top: 10px;
}

form input[type="text"], form input[type="datetime-local"], form textarea
	{
	width: 100%;
	padding: 10px;
	margin-top: 5px;
	border: 1px solid #ddd;
	border-radius: 5px;
}

form textarea {
	height: 100px;
	resize: vertical;
}

form input[type="submit"] {
	background-color: #5cb85c;
	color: white;
	padding: 10px 20px;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	margin-top: 20px;
}

form input[type="submit"]:hover {
	background-color: #4cae4c;
}

/* main */
body {
	position: relative;
	display: flex;
	width: 100%;
	height: 100%;
	flex-direction: column;
	justify-content: center;
	align-items: center;
}

#container-main {
	position: absolute;
	/* height-max: 50% !important; */
	width: 50%;
	top: 20%;
	border: 1px solid #000;
	border-radius: 25px;
	z-index: 10;
	padding: 20px;
}

#foot-div {
	position: relative;
	top: 1000px;
	width: 80%;
}

form input[type="text"], form input[type="datetime-local"], form textarea,
	form select {
	border: 1px solid #ced4da;
	border-radius: 0.25rem;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* 鼠标悬停在输入框上时的效果 */
form input[type="text"]:hover, form input[type="datetime-local"]:hover,
	form textarea:hover, form select:hover {
	border-color: #adb5bd;
}

/* 调整按钮样式 */
form input[type="submit"] {
	background-color: #007bff; /* 主题蓝色 */
	border-color: #007bff;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* 鼠标悬停在按钮上时的效果 */
form input[type="submit"]:hover {
	background-color: #0069d9; /* 深一点的蓝色 */
	border-color: #0062cc;
}

.card {
	background-color: #f8f9fa; /* 浅灰色背景 */
	border: 1px solid #e0e0e0; /* 淡灰色边框 */
	border-radius: 0.5rem; /* 圆角 */
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); /* 轻微的阴影 */
}

#qqq {
	display: none;
}
</style>
</head>

<body>
	<div style="width: 200px" class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample"
     aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-body" style="padding: 0px; overflow-x: hidden">

        <div class="b-example-divider"></div>

        <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-white" style="width: 200px;">
            <a href="/member"
               class="d-flex align-items-center flex-shrink-0 p-3 link-dark text-decoration-none border-bottom">
                <svg class="bi me-2" width="30" height="24">
                    <use xlink:href="#bootstrap"/>
                </svg>
                <span class="fs-5 fw-semibold">會員首頁</span>
            </a>
            <div class="list-group list-group-flush border-bottom scrollarea">
                <a th:href="@{/member/chat}" class="list-group-item list-group-item-action py-3 lh-tight"
                   aria-current="true">
                    <div class="d-flex w-100 align-items-center justify-content-between">
                        <strong class="mb-1">聊天</strong>
                    </div>
                </a>
                <a th:href="@{/front_end/notify}" class="list-group-item list-group-item-action py-3 lh-tight"
                   aria-current="true">
                    <div class="d-flex w-100 align-items-center justify-content-between">
                        <strong class="mb-1">通知</strong>
                    </div>
                </a>
                <a th:href="@{/member/venOrder}" class="list-group-item list-group-item-action py-3 lh-tight"
                   aria-current="true">
                    <div class="d-flex w-100 align-items-center justify-content-between">
                        <strong class="mb-1">場地預訂</strong>
                    </div>
                </a>
                <a th:href="@{/membership/actreview}" class="list-group-item list-group-item-action py-3 lh-tight"
                   aria-current="true">
                    <div class="d-flex w-100 align-items-center justify-content-between">
                        <strong class="mb-1">活動管理</strong>
                    </div>
                </a>
            </div>
        </div>

        <div class="b-example-divider"></div>

    </div>
</div>

<div class="container">
    <header class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
        <button class="btn btn-primary fa fa-bars" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasExample" aria-controls="offcanvasExample"></button>
        <div class="col-md-3 mb-2 mb-md-0">
            <a th:href="@{front_end/zuo-huo}" class="d-inline-flex link-body-emphasis text-decoration-none">
                <img alt="zuo-huo" src="/front-end/zuo-huo/images/LogoName.jpg" style="width: 160px;">
            </a>
        </div>

        <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0">
            <li><a th:href="@{/membership/ZuoHuo}"
                   class="nav-link px-2 link-secondary">首頁</a></li>
            <li><a th:href="@{/act/joinAct}" class="nav-link px-2 link-secondary">瀏覽活動</a></li>
            <li><a th:href="@{/act/createAct}" class="nav-link px-2 link-secondary">舉辦活動</a></li>
            <li><a th:href="@{/front_end/venue/browse}"
                   class="nav-link px-2 link-secondary">場地租借</a></li>
            <li><a th:href="@{/faq/faqs}"
                   class="nav-link px-2 link-secondary">FAQs</a></li>
            <li><a th:href="@{/faq/faqs}"
                   class="nav-link px-2 link-secondary">關於我們</a></li>
        </ul>

        <div class="col-md-3 text-end">

            <!-- 這邊放會員登入後的選項 -->
            <div class="after-logging" th:if="${session.memId ne null}">
                <i class="icon bi bi-messenger" style="font-size: 25px; margin: 20px; color: blue;"></i>

                <!-- -------------------- 通知訊息功能 下拉選單 -------------------- -->
                <i class="icon bi bi-bell-fill" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown"
                   aria-expanded="false" style="font-size: 25px; color: yellow;"></i>

                <ul id="notify_ul" class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                    <li id="notify_a1"></li>
                    <li id="notify_a2"></li>
                    <li id="notify_a3"></li>
                    <li><a id="display_all" class="dropdown-item" th:href="@{front_end/notify}">顯示全部</a></li>
                </ul>
                <!-- -------------------- 通知訊息功能 下拉選單 END -------------------- -->

                <!-- class拿掉dropdown-toggle 有問題再加回來 -->
                <i class="icon bi bi-person-circle" id="dropdownMenuLink"
                   type="button" data-bs-toggle="dropdown" aria-expanded="false"
                   style="font-size: 40px; margin: 20px;"></i>

                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                    <li><a class="dropdown-item" href="#">個人資料</a></li>
                    <li><a id="SignOut" class="dropdown-item" th:href="@{/membership/login}">登出</a></li>
                </ul>

            </div>

        </div>
    </header>


	<main class="container mt-0">
		<section class="my-5">
			<h2 class="mb-3 text-center">修改活動</h2>
			<div class="card p-4">
				<form id="actUpdateForm" action="/act/updateAct" method="post"
					novalidate>

					<div class="mb-3" id="qqq">
						<label for="actId" class="form-label">活動編號:</label> <input
							type="number" class="form-control" id="actId" name="actId">
					</div>

					<div class="mb-3">
						<label for="actName" class="form-label">活動名稱:</label> <input
							type="text" class="form-control" id="actName" name="actName"
							required />
						<div class="invalid-feedback">活動名稱不得為空:</div>
					</div>

					<div class="mb-3">
						<label for="actUpper" class="form-label">報名人數上限:</label> <input
							type="number" class="form-control" id="actUpper" name="actUpper"
							required />
						<div class="invalid-feedback">報名人數不得為空:</div>
					</div>

					<div class="mb-3">
						<label for="actType" class="form-label">活動類型:</label> <select
							id="actType" class="form-select" name="actType" required>
							<!-- 動態填充活動類型 -->
						</select>
					</div>

					<!-- 日期和時間增加響應式 -->
					<div class="row g-3">
						<div class="col-md-6">
							<label for="regStartTime" class="form-label">活動報名開始時間:</label> <input
								type="datetime-local" class="form-control" id="regStartTime"
								name="regStartTime" required />
							<div class="invalid-feedback">活動報名開始時間不得為空:</div>
						</div>

						<div class="col-md-6">
							<label for="regEndTime" class="form-label">活動報名結束時間:</label> <input
								type="datetime-local" class="form-control" id="regEndTime"
								name="regEndTime" required />
							<div class="invalid-feedback">活動報名開始時間不得為空:</div>
						</div>
					</div>

					<div class="row g-3">
						<div class="col-md-6">
							<label for="actStartTime" class="form-label">活動開始時間:</label> <input
								type="datetime-local" class="form-control" id="actStartTime"
								name="actStartTime" required />
							<div class="invalid-feedback">活動開始時間不得為空:</div>
						</div>

						<div class="col-md-6">
							<label for="actEndTime" class="form-label">活動結束時間:</label> <input
								type="datetime-local" class="form-control" id="actEndTime"
								name="actEndTime" required />
							<div class="invalid-feedback">活動結束時間不得為空:</div>
						</div>
					</div>

					<div class="mb-3">
						<label for="actPic" class="form-label">新增活動圖片:</label> <input
							type="file" class="form-control" id="actPic" name="actPic"
							accept="image/gif, image/jpeg, image/png"> <img
							id="preview" src="" alt="Image preview" class="img-fluid mt-3"
							style="display: none; width: 465px; height: auto;">
					</div>


					<div class="mb-3">
						<label for="actLoc" class="form-label">活動縣市:</label> <select
							class="form-select" id="actLoc" name="actLoc">
							<option value="">請選擇縣市</option>
							<option value="台北市">台北市</option>
							<option value="基隆市">基隆市</option>
							<option value="新北市">新北市</option>
							<option value="宜蘭縣">宜蘭縣</option>
							<option value="桃園市">桃園市</option>
							<option value="新竹市">新竹市</option>
							<option value="新竹縣">新竹縣</option>
							<option value="苗栗縣">苗栗縣</option>
							<option value="台中市">台中市</option>
							<option value="彰化縣">彰化縣</option>
							<option value="南投縣">南投縣</option>
							<option value="嘉義市">嘉義市</option>
							<option value="嘉義縣">嘉義縣</option>
							<option value="雲林縣">雲林縣</option>
							<option value="台南市">台南市</option>
							<option value="高雄市">高雄市</option>
							<option value="澎湖縣">澎湖縣</option>
							<option value="金門縣">金門縣</option>
							<option value="屏東縣">屏東縣</option>
							<option value="台東縣">台東縣</option>
							<option value="花蓮縣">花蓮縣</option>
							<option value="連江縣">連江縣</option>
						</select> <label for="detailLoc" class="form-label">地點:</label> <input
							type="text" class="form-control" id="detailLoc" name="actEndTime"
							required />
						<div class="invalid-feedback">活動地點不得為空:</div>
					</div>
					<div class="mb-3">
						<label for="actDescr" class="form-label">活動說明:</label>
						<textarea class="form-control" id="actDescr" name="actDescr"
							rows="4" required></textarea>
						<div class="invalid-feedback">活動說明不得為空:</div>
					</div>
					<div class="text-center">
						<button type="submit" class="btn btn-success">更新活動</button>
					</div>
				</form>
			</div>
		</section>
	</main>

	<div class="container" id="foot-div">
		<footer class="py-3 my-4">
			<ul class="nav justify-content-center border-bottom pb-3 mb-3">
				<li class="nav-item"><a href="index.html"
					class="nav-link px-2 text-muted">首頁</a></li>
				<li class="nav-item"><a href="../static/web/customer.html"
					class="nav-link px-2 text-muted">客服中心</a></li>
				<li class="nav-item"><a href="../static/web/about.html"
					class="nav-link px-2 text-muted">關於我們</a></li>
			</ul>
			<p class="text-center text-muted">© 2023 Company, Inc</p>
		</footer>
	</div>

</body>

<script>
  const actId = new URLSearchParams(window.location.search).get('id');
  $(document).ready(function () {
    // 從 URL 得到活動 ID
    if (actId) {
      getActById(actId); // 使用活動 ID 得到活動詳情
    }

    // 取得活動類型清單
    $.ajax({
      url: "/type/actTypes",
      type: "GET",
      dataType: "json",
      success: function (types) {
        var select = $('#actType');
        $.each(types, function (index, type) {
          select.append($('<option>', {
            value: type.actTypeId,
            text: type.actTypeName
          }));
        });
      },
      error: function (xhr, status, error) {
        console.error(error);
      }
    });

    // 圖片預覽
    $("#actPic").change(function () {
      if (this.files && this.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
          $("#preview").attr('src', e.target.result).show();
        };
        reader.readAsDataURL(this.files[0]);
      } else {
        $("#preview").hide();
      }
    });


    function formatDateTime(dateTimeString) {
      const [date, time] = dateTimeString.split('T');
      return date + ' ' + time + ':00'; // 假設後端需要秒
    }

    function validateDateTime(start, end) {
      var startDate = new Date(start);
      var endDate = new Date(end);
      return startDate <= endDate;
    }

    // 提交表單
    $('#actUpdateForm').submit(function (e) {
      e.preventDefault();

      // 獲取並格式化日期時間
      var regStart = formatDateTime($('#regStartTime').val());
      var regEnd = formatDateTime($('#regEndTime').val());
      var actStart = formatDateTime($('#actStartTime').val());
      var actEnd = formatDateTime($('#actEndTime').val());

      // 假設表單初始狀態有效
      var isValid = true;

      // 驗證每個輸入的值
      $('.form-control').each(function () {
        if (!this.checkValidity()) {
          $(this).addClass('is-invalid');
          isValid = false; // 如果有一個無效，將表單狀態設為false
        }
      });

      // 驗證報名時間
      if (!validateDateTime(regStart, regEnd)) {
        alert('報名開始時間不得晚於報名結束時間。');
        return; // 阻止表單提交
      }

      // 驗證活動時間
      if (!validateDateTime(actStart, actEnd)) {
        alert('活動開始時間不得晚於活動結束時間。');
        return; // 阻止表單提交
      }

      // 驗證活動開始時間不得早於報名結束時間
      if (!validateDateTime(regEnd, actStart)) {
        alert('活動開始時間不得早於報名結束時間。');
        return; // 阻止表單提交
      }

      // 驗證活動結束時間不得早於報名開始時間
      if (!validateDateTime(regStart, actEnd)) {
        alert('活動結束時間不得早於報名開始時間。');
        return; // 阻止表單提交
      }
      if (!isValid) {
        return;// 若表單無效 阻止提交
      }

      // 如果驗證通過，繼續表單提交邏輯
      let formData = new FormData();
      formData.append("actId", $('#actId').val());
      formData.append("actName", $('#actName').val());
      formData.append("actUpper", $('#actUpper').val());
      formData.append("regStartTime", regStart);
      formData.append("regEndTime", regEnd);
      formData.append("actStartTime", actStart);
      formData.append("actEndTime", actEnd);
      formData.append("actLoc", $('#actLoc').val() + $('#detailLoc').val());
      formData.append("actDescr", $('#actDescr').val());
      formData.append("actType", $('#actType').val());
      // 表單中有新增的屬性這邊也要添加

      let fileInput = $("#actPic")[0];
      let file = fileInput.files[0];
      if (file) {
        formData.append("actPic", file);
      }

      // 發送 AJAX 請求來更新活動
      $.ajax({
        url: '/act/addOrUpdateAct',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          alert('活動更新成功！');
          window.location.href = "joinAct"; //跳轉頁面
        },
        error: function (XHR, Status, error) {
          alert('更新活動失敗，請檢查輸入是否正確。');
        }
      });
    });
  });

  // 獲取活動的資料
  function getActById(actId) {
    $.ajax({
      url: "/act/" + actId,
      type: "GET",
      success: function (actVO) {
        $('#actId').val(actVO.actId);
        $('#actName').val(actVO.actName);
        $('#actUpper').val(actVO.actUpper);
        $('#actType').val(actVO.actType);
        $('#regStartTime').val(new Date(actVO.regStartTime).toISOString().slice(0, 16));
        $('#regEndTime').val(new Date(actVO.regEndTime).toISOString().slice(0, 16));
        $('#actStartTime').val(new Date(actVO.actStartTime).toISOString().slice(0, 16));
        $('#actEndTime').val(new Date(actVO.actEndTime).toISOString().slice(0, 16));
        $('#actLoc').val(actVO.actLoc);
        $('#actDescr').val(actVO.actDescr);
        
        
        if (actVO.actPic) {
            // 假設actPic字段是圖片的Base64編碼數據
            var imgSrc = "data:image/jpeg;base64," + actVO.actPic;
            $('#preview').attr('src', imgSrc).show(); // 設置src屬性並顯示圖片
        }

      },
      error: function (xhr, status, error) {
        console.error("Error fetching activity details:", error);
      }
    });
  }



  //------------------------ 登出 -------------------------
  document.getElementById("SignOut").addEventListener("click",
      function () {
          // 使用 XMLHttpRequest 或 Fetch API 發送登出請求到後端
          var xhr = new XMLHttpRequest();
          xhr.open("GET", "/membership/logout", true);

          xhr.onreadystatechange = function () {
              if (xhr.readyState == 4 && xhr.status == 200) {
                  webSocket.close();
                  // 處理登出成功的回應，這裡將重新導向到登入頁面
                  window.location.href = "/membership/login"; // 重新導向到登入頁面
              }
          };
          xhr.send();
      });
</script>
</html>
